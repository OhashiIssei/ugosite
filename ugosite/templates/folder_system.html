<script>
    if(document.querySelector(".player")){
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
    }
</script>

<script defer>
    folderSystem()
    function folderSystem(){
        for(let folder of document.querySelectorAll("#folders .folder")){
            folder.querySelector(":scope>a").addEventListener("click",()=>selectFolder(folder)) 
        }
        function selectFolder(folder){
            folder.parentNode.querySelectorAll(".folder").forEach((f)=>f.classList.remove("selected"))
            folder.classList.add("selected")
            // pool(folder.cloneNode(true))
        }
        // const poollist = document.createElement("ul")
        // document.getElementById("files").appendChild(poollist)
        function pool(folder){
            while(poollist.firstChild){
                poollist.removeChild(poollist.firstChild)
            }
            document.getElementById("files").appendChild(folder)
            for(let file of folder.querySelectorAll(".file")){
                // poollist.appendChild(file)
                console.log("poollistに"+file+"を追加する")
                file.addEventListener("click",()=>selectFile(file))
            }
            function selectFile(file){
                    document.querySelectorAll("#files .file").forEach((f)=>f.classList.remove("selected"))
                    file.classList.add("selected")
                    display(file.cloneNode(true))
                }
        }
        const detailDiv = document.getElementById("file-detail")
        function display(file){
            console.log(file+"をdetailに表示します")
            const detail = file.lastElementChild
            while(detailDiv.firstChild){
                detailDiv.removeChild(detailDiv.firstChild)
            }
            detailDiv.appendChild(detail)
            if(detailDiv.querySelector(".player")){
                width = detailDiv.clientWidth
                add_video(file.getAttribute("itemid"),width)
            }
        }

        function add_video(slug,width){
            detailDiv.querySelector(".player").setAttribute("id","player")
            var player;
            player = new YT.Player('player',{
                height: width*9/16,
                width: width,
                videoId: slug,
            });
            var table
            table = detailDiv.querySelector(".table")
            if(table){
                for(let i=0; i < table.children.length;i++){
                    const line = table.children[i].firstChild
                    line.addEventListener("click",function(){
                    const timeCord = line.textContent.match(/([\d]+):([\d]+)/g)[0]
                    console.log(timeCord)
                    const time = Number(timeCord.slice(0,2))*60+Number(timeCord.slice(3,5))
                    console.log(time)
                    player.seekTo(time, Boolean)
                    })
                    table.children[i].firstChild.setAttribute("href",'javascript:void(0);')
                }
            }
        }
        
        //article内のproblemまで表示させるための関数
        document.querySelectorAll("#folders .file").forEach(
            (file)=>file.firstElementChild.addEventListener("click",()=>createTable(file))
        )
        function createTable(file){
            file.parentNode.querySelectorAll(".file").forEach((f)=>f.classList.remove("selected"))
            file.classList.add("selected")
            display(file.cloneNode(true))
            for(let problem of file.querySelectorAll(".problems .problem")){
                const itemid = problem.getAttribute("itemid")
                detailDiv.querySelector('.problem[itemid="'+itemid+'"]').setAttribute("id",itemid)
            }
        }

        document.querySelector("main").addEventListener("scroll",function(){
            let nowTop = 1000000
            let disP
            if(detailDiv.querySelectorAll(".problem")){
                for(let problem of detailDiv.querySelectorAll(".problem")){
                    let top = problem.getBoundingClientRect().top
                    if(top>60 && top<nowTop){
                        nowTop = top
                        disP = problem
                        console.log("現在の表示問題は"+problem.querySelector("a").textContent+"です。")
                    } 
                }
                document.querySelectorAll(".problem").forEach((l)=>l.classList.remove("selected"))
                let id = disP.getAttribute("id")
                document.querySelectorAll('.problem[itemid="'+id+'"]').forEach((l)=>l.classList.add("selected"))
            }
        })
    }
</script>

